+++
title = "GitOps"
description = "Running Kubeflow using the GitOps methodology"
weight = 10
toc = true
bref = "This guide describes how to setup kubeflow using a GitOps methodology by leveraging Argo-CD"

[menu.docs]
  parent = "guides"
  weight = 30
+++

## What is GitOps

## Before you start
This guide assumes you have a kubernetes cluster running. If you havenâ€™t done so, follow [this guide](/docs/started/getting-started/#set-up-kubernetes).

## Install Argo CD
Follow the [argo-cd getting start guide](https://github.com/argoproj/argo-cd/blob/master/docs/getting_started.md) up to the '[Create an application from a git repository location](https://github.com/argoproj/argo-cd/blob/master/docs/getting_started.md#6-create-an-application-from-a-git-repository-location)' step

* For example, if your local machine is OSX and you want to deploy Argo CD and Kubeflow to the same GKE cluster, you could run:

1. Install ArgoCD to the Kubernetes Cluster
```shell
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v0.9.2/manifests/install.yaml
```

1. Install ArgoCD Cli
```shell
brew install argoproj/tap/argocd
```

1. Expose the Argo CD API server
```shell
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
```
1. Login using the CLI as admin user
    
    The initial password for the admin user is autogenerated to be the pod name of the ArgoCD API server. This can be retrieved with the command:

    ```shell
    kubectl get pods -n argocd -l app=argocd-server -o name | cut -d'/' -f 2
    ```

    Using the above password, login to ArgoCD's external IP:
    ```shell
    kubectl get svc -n argocd argocd-server
    argocd login <EXTERNAL-IP>
    ```
    After logging in, change the password using the command:
    ```shell
    argocd account update-password
    argocd relogin
    ```

## Create Kubeflow deployment repo
1. Create a git repo to store your Kubeflow configuration.
1. If you did not use the `kfctl.sh` script to create your kubernetes cluster and generate the kubernetes resources:
    1. Run the following script to download `kfctl.sh`:

        ```shell
        mkdir ${KUBEFLOW_REPO}
        cd ${KUBEFLOW_REPO}
        export KUBEFLOW_TAG={{% kf-stable-tag %}}
        curl https://raw.githubusercontent.com/kubeflow/kubeflow/${KUBEFLOW_TAG}/scripts/download.sh | shell
        ```
        * **KUBEFLOW_REPO** directory where you want to download the source to
        * **KUBEFLOW_TAG** a tag corresponding to the version to checkout such as `master` for latest code.
        * **Note** you can also just clone the repository using git.
    1. Run the following scripts to set up your Kubeflow KS application:

        ```
        ${KUBEFLOW_REPO}/scripts/kfctl.sh init ${KFAPP} --platform none
        cd ${KFAPP}
        ${KUBEFLOW_REPO}/scripts/kfctl.sh generate k8
        ```
        * **KFAPP** directory to store all of your kubeflow configuration

1. Add the environment to your ksonnet application:
    * If you are deploying kubeflow in the same cluster as Argo CD, run:

    ```shell
    ks env add default --server https://kubernetes.default.svc
    ```
    otherwise run:
    ```shell
    ks env add default
    argocd cluster add CONTEXTNAME
    ```
    * **CONTEXTNAME** Context name of the Kubernetes cluster you want to deploy into.
1.  Add the contents of the KSAPP directory to git repo you created in the first step.

## Deploying Kubeflow
1. Run the following commands to create the Kubeflow application in Argo-CD and then sync the manifests in your git repo to your cluster:

    ```shell
    export KUBEFLOW_REPO_URL='Replace with a ssh or https git endpoint'
    argocd app create kubeflow --name kubeflow --repo $KUBEFLOW_REPO_URL --path ks_app --env default
    argocd app sync kubeflow
    ```
    * You can view the Kubeflow application by running: 
    ```argocd app get kubeflow```
    or by going to the UI.
    * NOTE: There is a known issue where the envoy service will never turn healthy.

## More ArgoCD configuration
Please go to the (ArgoCD documention)[https://github.com/argoproj/argo-cd/tree/master/docs#argocd-documentation] to read more about how to configure other features like SSO, RBAC, and more.